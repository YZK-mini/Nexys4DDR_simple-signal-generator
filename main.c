#include "stdio.h"
#include "xintc_l.h"
#include "xil_io.h"
#include "xtmrctr_l.h"
#include "xspi_l.h"
#include "xgpio.h"
#include "xuartlite.h"

//地址常参数定义
#define sw_DATA 0x40000000
#define sw_TRI 0x40000004
#define led_DATA 0x40000008
#define led_TRI 0x4000000c
#define btn_DATA 0x40020000
#define btn_TRI 0x40020004

#define sw_GIER 0x4000011c
#define sw_IER 0x40000128
#define sw_ISR 0x40000120
#define btn_GIER 0x4002011c
#define btn_IER 0x40020128
#define btn_ISR 0x40020120

#define seg_DATA 0x40010000
#define seg_TRI 0x40010004
#define pos_DATA 0x40010008
#define pos_TRI 0x4001000c

#define intc_ISR 0x41200000
#define intc_IER 0x41200008
#define intc_IAR 0x4120000c
#define intc_MER 0x4120001c
#define intc_IMR 0x41200020

#define tim_TCSR 0x41c00000
#define tim_TLR 0x41c00004
#define tim_TCR 0x41c00008

#define spi_SPICR 0x44a00060
#define spi_SPISSR 0x44a00070
#define spi_IPIER 0x44a00028
#define spi_IPISR 0x44a00020
#define spi_DGIER 0x44a0001c
#define spi_SPIDTR 0x44a00068

#define uart_RX 0x40600000
#define uart_TX 0x40600004
#define uart_CTR 0x4060000c
#define uart_STATS 0x40600008

short int Point = 0; // 当前采样点
int SET_VALUE = 500000;    // 计数器计数周期
int frequency = 1;         // 当前频率

int Sc[7]={1024,1024,1024,1024,1024,1024,1024};
int A = 4096;                   //信号幅值控制
int set = 2; //选择占空比
int choice = 0;                   //波形选择控制
int high_low = 100;

// 200 个采样点的 sin 函数数据
float sin_data[] = {1.0, 1.0315685497648106, 1.0631056313126737, 1.094579807794845, 1.1259597050677175, 1.1572140429672508, 1.1883116664897178, 1.2192215768476913, 1.2499129623703085, 1.2803552292170144, 1.3105180318741687, 1.3403713034041127, 1.3698852854165469, 1.399030557732341, 1.4277780677102097, 1.456099159207016, 1.4839656011428386, 1.5113496156423267, 1.5382239057242886, 1.564561682511918, 1.5903366919365283, 1.6155232409081792, 1.6400962229271072, 1.664031143110431, 1.6873041426091842, 1.7098920223913328, 1.7317722663670767, 1.752923063833377, 1.7733233312153391, 1.7929527330827786, 1.8117917024210208, 1.8298214601357259, 1.847024033772299, 1.8633822754312233, 1.8788798788614605, 1.893501395714874, 1.9072322509454813, 1.9200587573381744, 1.9319681291524349, 1.9429484948674371, 1.9529889090158392, 1.9620793630944628, 1.9702107955409862, 1.9773751007667073, 1.9835651372363698, 1.9887747345870026, 1.9929986997786697, 1.9962328222710068, 1.9984738782203788, 1.999719633693478, 1.9999688468941563, 1.9992212694012756, 1.9974776464163386, 1.994739716020657, 1.991010207442792, 1.9862928383380027, 1.980592311082404, 1.9739143080855377, 1.9662654861260218, 1.9576534697159296, 1.9480868435005094, 1.937575143700825, 1.9261288486078412, 1.9137593681374367, 1.9004790324567518, 1.8863010796932087, 1.8712396427384597, 1.8553097351604118, 1.8385272362373772, 1.8209088751292626, 1.802472214201578, 1.7832356315188904, 1.7632183025251684, 1.7424401809292829, 1.7209219788147163, 1.6986851459933066, 1.6757518486236087, 1.6521449471151868, 1.6278879733408584, 1.6030051071796145, 1.5775211524135886, 1.5514615120031077, 1.5248521627644684, 1.497719629475683, 1.470090958436003, 1.441993690505579, 1.4134558336521341, 1.384505835032011, 1.3551725526334286, 1.3254852265102115, 1.29547344963467, 1.2651671383986787, 1.2345965027923689, 1.2037920162901523, 1.1727843854740994, 1.1416045194249516, 1.110283498911275, 1.0788525454074767, 1.0473429899715583, 1.0157862420136368, 0.984213757986363, 0.952657010028442, 0.9211474545925237, 0.8897165010887251, 0.8583954805750482, 0.8272156145259004, 0.7962079837098479, 0.7654034972076313, 0.7348328616013216, 0.7045265503653302, 0.6745147734897882, 0.6448274473665716, 0.6154941649679893, 0.5865441663478661, 0.5580063094944211, 0.5299090415639969, 0.5022803705243168, 0.4751478372355318, 0.44853848799689267, 0.4224788475864115, 0.3969948928203857, 0.37211202665914156, 0.34785505288481344, 0.3242481513763913, 0.30131485400669367, 0.2790780211852838, 0.2575598190707168, 0.2367816974748318, 0.2167643684811097, 0.1975277857984219, 0.17909112487073753, 0.16147276376262254, 0.14469026483958836, 0.12876035726154045, 0.11369892030679118, 0.09952096754324846, 0.08624063186256326, 0.07387115139215894, 0.062424856299174936, 0.051913156499490354, 0.04234653028407054, 0.03373451387397808, 0.026085691914462306, 0.019407688917595922, 0.013707161661997258, 0.008989792557207887, 0.005260283979342972, 0.002522353583661263, 0.0007787305987243531, 3.1153105843673146e-05, 0.00028036630652206185, 0.0015261217796211923, 0.003767177728993265, 0.0070013002213303865, 0.011225265412997398, 0.016434862763630043, 0.022624899233292806, 0.029789204459013674, 0.03792063690553715, 0.047011090984160564, 0.05705150513256296, 0.06803187084756523, 0.07994124266182545, 0.09276774905451868, 0.1064986042851257, 0.12112012113853965, 0.13661772456877674, 0.15297596622770104, 0.17017853986427423, 0.18820829757897906, 0.20704726691722142, 0.2266766687846612, 0.24707693616662285, 0.2682277336329233, 0.2901079776086669, 0.31269585739081573, 0.33596885688956835, 0.35990377707289267, 0.384476759091821, 0.4096633080634713, 0.4354383174880819, 0.461776094275711, 0.4886503843576733, 0.5160343988571614, 0.5439008407929837, 0.5722219322897905, 0.6009694422676586, 0.630114714583453, 0.6596286965958873, 0.6894819681258308, 0.7196447707829856, 0.7500870376296912, 0.7807784231523085, 0.8116883335102824, 0.842785957032749, 0.8740402949322825, 0.9054201922051546, 0.9368943686873263, 0.9684314502351897, 0.9999999999999998};
float heart_data[] = {3121,3111,3100,3090,3080,3070,3059,3049,3039,3028,3018,3089,2873,2606,2556,2826,3267,3567,3475,2995,2409,2107,2316,2930,3557,3766,3382,2618,1955,1833,2352,3191,3800,3761,3066,2140,1578,1752,2565,3496,3929,3560,2600,1655,1334,1853,2885,3759,3894,3179,2055,1239,1258,2106,3237,3912,3676,2660,1506,950,1354,2458,3545,3902,3279,2060,1021,826,1601,2843,3742,3704,2735,1446,657,873,1950,3187,3773,3316,2094,881,450,1072,2336,3418,3605,2761,1414,419,405,1369,2677,3469,3217,2065,736,65,461,1619,2918,3396,2794,1526,431,232,1075,2430,3440,3471,2518,1213,409,635,1755,3058,3716,3321,2143,956,533,1153,2423,3533,3781,3024,1766,829,821,1751,3022,3827,3661,2651,1461,867,1251,2366,3498,3929,3401,2273,1285,1076,1777,2934,3808,3853,3062,1964,1274,1434,2333,3390,3934,3637,2717,1781,1436,1894,2848,3684,3883,3343,2441,1769,1753,2386,3247,3789,3689,3049,2307,1946,2177,2826,3462,3693,3413,2849,2390,2320,2642,3104,3395,3366,3121,2926,3018,3028,3039,3049,3059,3070,3080,3090,3100,3111,3121,3131};
float round_data[] = {2,1.7179,2.398,1.5138,2.56,1.3755,2.6823,1.2649,2.7838,1.1708,2.8718,1.0881,2.9499,1.0139,3.0206,0.94643,3.0852,0.88447,3.1447,0.82714,3.2,0.77379,3.2516,0.72391,3.2998,0.67712,3.3452,0.63311,3.3879,0.5916,3.4283,0.55238,3.4664,0.51528,3.5025,0.48013,3.5367,0.44681,3.5692,0.4152,3.6,0.38519,3.6292,0.35671,3.657,0.32967,3.6833,0.304,3.7083,0.27965,3.7321,0.25656,3.7545,0.23467,3.7758,0.21394,3.796,0.19434,3.815,0.17583,3.833,0.15837,3.85,0.14194,3.8659,0.1265,3.8809,0.11204,3.8948,0.098527,3.9079,0.085947,3.92,0.074279,3.9312,0.063508,3.9415,0.053619,3.951,0.044597,3.9596,0.036432,3.9673,0.029112,3.9742,0.022628,3.9803,0.016972,3.9855,0.012137,3.99,0.0081165,3.9936,0.004906,3.9964,0.0025016,3.9984,0.0009002,3.9996,0.0001,4,0.0001,3.9996,0.0009002,3.9984,0.0025016,3.9964,0.004906,3.9936,0.0081165,3.99,0.012137,3.9855,0.016972,3.9803,0.022628,3.9742,0.029112,3.9673,0.036432,3.9596,0.044597,3.951,0.053619,3.9415,0.063508,3.9312,0.074279,3.92,0.085947,3.9079,0.098527,3.8948,0.11204,3.8809,0.1265,3.8659,0.14194,3.85,0.15837,3.833,0.17583,3.815,0.19434,3.796,0.21394,3.7758,0.23467,3.7545,0.25656,3.7321,0.27965,3.7083,0.304,3.6833,0.32967,3.657,0.35671,3.6292,0.38519,3.6,0.4152,3.5692,0.44681,3.5367,0.48013,3.5025,0.51528,3.4664,0.55238,3.4283,0.5916,3.3879,0.63311,3.3452,0.67712,3.2998,0.72391,3.2516,0.77379,3.2,0.82714,3.1447,0.88447,3.0852,0.94643,3.0206,1.0139,2.9499,1.0881,2.8718,1.1708,2.7838,1.2649,2.6823,1.3755,2.56,1.5138,2.398,1.7179};
float xing_data[]={2,2.0001,1.9996,2.0009,1.9984,2.0025,1.9964,2.0049,1.9936,2.0081,1.99,2.0121,1.9855,2.017,1.9803,2.0226,1.9742,2.0291,1.9673,2.0364,1.9596,2.0446,1.951,2.0536,1.9415,2.0635,1.9312,2.0743,1.92,2.0859,1.9079,2.0985,1.8948,2.112,1.8809,2.1265,1.8659,2.1419,1.85,2.1584,1.833,2.1758,1.815,2.1943,1.796,2.2139,1.7758,2.2347,1.7545,2.2566,1.7321,2.2797,1.7083,2.304,1.6833,2.3297,1.657,2.3567,1.6292,2.3852,1.6,2.4152,1.5692,2.4468,1.5367,2.4801,1.5025,2.5153,1.4664,2.5524,1.4283,2.5916,1.3879,2.6331,1.3452,2.6771,1.2998,2.7239,1.2516,2.7738,1.2,2.8271,1.1447,2.8845,1.0852,2.9464,1.0206,3.0139,0.94995,3.0881,0.87178,3.1708,0.78384,3.2649,0.68235,3.3755,0.56,3.5138,0.39799,4,3.7179,0.39799,3.5138,0.56,3.3755,0.68235,3.2649,0.78384,3.1708,0.87178,3.0881,0.94995,3.0139,1.0206,2.9464,1.0852,2.8845,1.1447,2.8271,1.2,2.7738,1.2516,2.7239,1.2998,2.6771,1.3452,2.6331,1.3879,2.5916,1.4283,2.5524,1.4664,2.5153,1.5025,2.4801,1.5367,2.4468,1.5692,2.4152,1.6,2.3852,1.6292,2.3567,1.657,2.3297,1.6833,2.304,1.7083,2.2797,1.7321,2.2566,1.7545,2.2347,1.7758,2.2139,1.796,2.1943,1.815,2.1758,1.833,2.1584,1.85,2.1419,1.8659,2.1265,1.8809,2.112,1.8948,2.0985,1.9079,2.0859,1.92,2.0743,1.9312,2.0635,1.9415,2.0536,1.951,2.0446,1.9596,2.0364,1.9673,2.0291,1.9742,2.0226,1.9803,2.017,1.9855,2.0121,1.99,2.0081,1.9936,2.0049,1.9964,2.0025,1.9984,2.0009,1.9996,2.0001,2};

void Initialize();//初始化

// 设定中断服务程序
void My_ISR() __attribute__((interrupt_handler));
void buttonHandler();
void timerHandler();
void swHandler();
void get_data();

int main()
{
    Initialize();
    // 启动传输，发送数据0，开启DA转换
    Xil_Out16(spi_SPIDTR, 0);

    while(1);
    return 0;
}

void Initialize()
{
	int tmp1, tmp2;

	// SPI DA 模块初始化
	//设定SPI为主设备，CPOL=0,CPHA=1,自动方式，高位优先发送
	Xil_Out32(spi_SPICR, 0x16);
	Xil_Out32(spi_SPISSR, 0xfffffffe);

	// INTC 模块初始化
	// 设置普通中断方式
	Xil_Out32(intc_IMR, 0x0);
	// 清空当前 INTC 模块中断状态
	Xil_Out32(intc_IAR, 0xffffffff);
	// 中断控制器控制源使能
	Xil_Out32(intc_MER, 0x3);
	// 使能开关、按钮、Timer 的中断输入
	Xil_Out32(intc_IER, 0x23);

	// Timer 模块初始化
	// 停止 TIMER 定时器计时
	Xil_Out32(tim_TCSR, Xil_In32(tim_TCSR) & ~XTC_CSR_ENABLE_TMR_MASK);
	// 将预置值填入TLR，设定计时周期
    Xil_Out32(tim_TLR, SET_VALUE);
    // 装载预置值
    Xil_Out32(tim_TCSR, Xil_In32(tim_TCSR) | XTC_CSR_LOAD_MASK);
    // 设定 TIMER 定时器开始计时，自动获取，允许中断，减计数
    tmp1 = XTC_CSR_ENABLE_TMR_MASK | XTC_CSR_ENABLE_INT_MASK | XTC_CSR_DOWN_COUNT_MASK | XTC_CSR_AUTO_RELOAD_MASK;
    tmp2 = (Xil_In32(tim_TCSR) & ~XTC_CSR_LOAD_MASK) | tmp1;
    Xil_Out32(tim_TCSR, tmp2);

    //开关初始化
    Xil_Out32(sw_ISR, 0x1);
    // 设置 16 位开关为输入
    Xil_Out32(sw_TRI, 0xffff);
    // 设置  16 位 LED 灯为输出
    Xil_Out32(led_TRI, 0x0);
    // 使能 GPIO_0 模块总中断请求
    Xil_Out32(sw_GIER, 0x80000000);
    // 使能开关中断
    Xil_Out32(sw_IER, 0x1);

    //按钮初始化
    Xil_Out32(btn_ISR, 0x1);
    // 设置5 个按键为输入
    Xil_Out32(btn_TRI, 0x1f);
    // 使能 GPIO_2 模块总中断请求
    Xil_Out32(btn_GIER, 0x80000000);
    //使能按键中断
    Xil_Out32(btn_IER, 0x1);

    //uart0初始化
	Xil_Out32(uart_CTR,0x13);

	// 允许处理器中断
    microblaze_enable_interrupts();
}

void My_ISR()
{
    int status;
    status = Xil_In32(intc_ISR); //读取INTC中断状态
    // TIMER中断
    if ((status & 0x20) == 0x20)
    	timerHandler();
    // 按钮中断
    if ((status & 0x02) == 0x02)
        buttonHandler();
    // 开关中断
    if ((status & 0x01) == 0x01)
        swHandler();
    //清除 INTC 模块中断状态
    Xil_Out32(intc_IAR, status);
}

void timerHandler()
{
	switch (set)
	{

	case 0:
		{
			high_low=20;
			break;
		}

	case 1:
		{
			high_low=50;
			break;
		}

	case 2:
		{
			high_low=100;
			break;
		}

	case 3:
		{
			high_low=150;
			break;
		}
	}

    // 计算当前需要输出的采样点
    Point = (Point + 1) % 200;
    // 根据波形决定输出公式
    switch (choice)
    {
    case 0x1:
    { //正弦波
        // 输出对应的正弦信号采样点数据
        Xil_Out16(spi_SPIDTR, (int)(((A - 1) * sin_data[Point])/4.0));
        break;
    }

    case 0x2:
    { //三角波
        if (Point <= high_low)
        		Xil_Out16(spi_SPIDTR, (A - 1) * Point / 100);
        else
        		Xil_Out16(spi_SPIDTR, (A - A * (Point - 100) / 100));
        break;
    }

    case 0x4:
    { //正方波
        if (Point < high_low)
        	Xil_Out16(spi_SPIDTR, A-1);
        else
        	Xil_Out16(spi_SPIDTR, 0x0);
        break;
    }

    case 0x8:
    { //锯齿波
        Xil_Out16(spi_SPIDTR, Point * (A - 1) / 200);
        break;
    }

    case 0x10:
    { //心形波
    	// 输出对应的心形波采样点数据
        Xil_Out16(spi_SPIDTR, (int)(heart_data[Point]));
        break;
    }

    case 0x20:
    { //圆形波
        // 输出对应的圆形波采样点数据
        Xil_Out16(spi_SPIDTR, (int)(((A - 1) * round_data[Point])/4.0));
        break;
    }

    case 0x40:
    { //星形波
        // 输出对应的星形波采样点数据
        Xil_Out16(spi_SPIDTR, (int)(((A - 1) * xing_data[Point])/4.0));
        break;
     }

    case 0x80:
    {//屏幕输入8个数据，生成相应离散波形
    	if (!(Point%34))
    		Xil_Out16(spi_SPIDTR,Sc[Point/25]);
    }

    default:
        Xil_Out16(spi_SPIDTR, 0); //默认为0
    }
    Xil_Out32(tim_TCSR, Xil_In32(tim_TCSR)); //TIMER清中断
}

void swHandler()
{
    // 读取低  8 位开关，作为波形控制信号
    choice = Xil_In16(sw_DATA) & 0xff;
    // 占空比 10%
    if ((Xil_In16(sw_DATA) & 0xc000) == 0xc000)
    	set = 0;
    // 占空比 25%
    else if ((Xil_In16(sw_DATA) & 0x8000) == 0x8000)
    	set = 1;
    // 占空比 50%
    else if ((Xil_In16(sw_DATA) & 0x4000) == 0x4000)
    	set = 2;
    // 占空比 75%
    else if ((Xil_In16(sw_DATA) & 0x0000) == 0x0000)
    	set = 3;

    // 开关状态同步到 LED 灯
    Xil_Out16(led_DATA, Xil_In16(sw_DATA)&0xff);

    //读取8个数据
    if (Xil_In16(sw_DATA)&0x3f00)
    	get_data();

    // 开关清中断
    Xil_Out32(sw_ISR, Xil_In32(sw_ISR));
}

void buttonHandler()
{
	int tmp1,tmp2;
    int btndata = Xil_In32(btn_DATA); //读取按键状态

    switch (btndata) // 判断按下按键
    {

    case (0x2): // BTNU，增大1hz频率
    {
        frequency = frequency + 1;
        if (frequency > 30)
        {
             frequency = 30;//频率上限30Hz
        }
        SET_VALUE = (int)(1000000 / (2 * frequency));
        // 计算需要输出的每个采样点间隔时间
        xil_printf("frequency=%d\n\r", frequency);
        break;
    }

    case (0x10): // BTND，减小频率1hz
    {
        frequency = frequency - 1;
        // 最低只允许输出 1Hz 信号
        if (frequency < 1)
        {
            frequency = 1;//频率下限1Hz
        }
        // 计算需要输出的每个采样点间隔时间
        SET_VALUE = (int)(1000000 / (2 * frequency));
        xil_printf("frequency=%d\n\r", frequency);
        break;
    }

    case (0x4): // BTNL，增大幅值
    {
        A += 128;
        if (A > 4096)
        {
             A = 4096;
        }
        break;
    }

    case (0x8): // BTNR，减小幅值
    {
        A -= 128;
        if (A < 128)
        {
             A = 128;
        }
        break;
    }
    }

    // 根据按键状态修改TIMER参数
    Xil_Out32(tim_TCSR, Xil_In32(tim_TCSR) & ~XTC_CSR_ENABLE_TMR_MASK);
    Xil_Out32(tim_TLR, SET_VALUE);
    Xil_Out32(tim_TCSR, Xil_In32(tim_TCSR) | XTC_CSR_LOAD_MASK);
    tmp1 = XTC_CSR_ENABLE_TMR_MASK | XTC_CSR_ENABLE_INT_MASK | XTC_CSR_DOWN_COUNT_MASK | XTC_CSR_AUTO_RELOAD_MASK;
    tmp2 = (Xil_In32(tim_TCSR) & ~XTC_CSR_LOAD_MASK) | tmp1;
    Xil_Out32(tim_TCSR, tmp2);

    // 按键清中断
    Xil_Out32(btn_ISR, Xil_In32(btn_ISR));
}

void get_data()
{

	int t=Xil_In16(sw_DATA)&0x3f00;

	switch (t)
	{

	case (0x2000):
		{
			while (t)
			{
				if(Xil_In16(btn_DATA))Sc[0]=Sc[0]+32;
				if (Sc[0]>4095) Sc[0]=0;
				xil_printf("Sc[0]=%d\n\r",Sc[0]);
			}
			break;
		}

	case (0x1000):
		{
			while (t)
			{
				if(Xil_In16(btn_DATA))Sc[1]=Sc[1]+32;
				if (Sc[1]>4095) Sc[1]=0;
				xil_printf("Sc[1]=%d\n\r",Sc[1]);
			}
			break;
		}

	case (0x0800):
		{
			while (t)
			{
				if(Xil_In16(btn_DATA))Sc[2]=Sc[2]+32;
				if (Sc[2]>4095) Sc[2]=0;
				xil_printf("Sc[2]=%d\n\r",Sc[2]);
			}
			break;
		}

	case (0x0400):
		{
			while (t)
			{
				if(Xil_In16(btn_DATA))Sc[3]=Sc[3]+32;
				if (Sc[3]>4095) Sc[3]=0;
				xil_printf("Sc[3]=%d\n\r",Sc[3]);
			}
			break;
		}

	case (0x0200):
		{
			while (t)
			{
				if(Xil_In16(btn_DATA))Sc[4]=Sc[4]+32;
				if (Sc[4]>4095) Sc[4]=0;
				xil_printf("Sc[4]=%d\n\r",Sc[4]);
			}
			break;
		}

	case (0x0100):
		{
			while (t)
			{
				if(Xil_In16(btn_DATA))Sc[5]=Sc[5]+32;
				if (Sc[5]>4095) Sc[5]=0;
				xil_printf("Sc[5]=%d\n\r",Sc[5]);
			}
			break;
		}
	}
}
